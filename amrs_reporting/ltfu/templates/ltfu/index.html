{% extends "ltfu/base.html" %}
{% load staticfiles %}
{% load ltfu_filters %}

{% block content %}

<script>

</script>


<script type="text/javascript">
  function download_defaulter_list() {
      var form = document.getElementById('defaulter_list_form');
      form.action = '/ltfu/ltfu_get_defaulter_list';
      form.submit();
  }

  function view_defaulter_list() {
      var form = document.getElementById('defaulter_list_form');
      form.action = '/ltfu/ltfu_by_range';
      form.submit();
  }



jQuery.extend( jQuery.fn.dataTableExt.oSort, {
    "percent-pre": function ( a ) {
        var x = (a == "-") ? 0 : a.replace( /%/, "" );
        return parseFloat( x );
    },
 
    "percent-asc": function ( a, b ) {
        return ((a < b) ? -1 : ((a > b) ? 1 : 0));
    },
 
    "percent-desc": function ( a, b ) {
        return ((a < b) ? 1 : ((a > b) ? -1 : 0));
    }
} );

  $(document).ready(function() {

  $('#system_indicators').dataTable( {
  "sScrollY": "100px",
  "bJQueryUI": true,
  "bPaginate": false,
  "bLengthChange": false,
  "bFilter": true,
  "bSort": true,
  "bInfo": false,
  "bAutoWidth": false } );


  $('#clinic_indicators').dataTable( {
  "sScrollY": "100px",
  "bJQueryUI": true,
  "bPaginate": false,
  "bLengthChange": false,
  "bFilter": true,
  "bSort": true,
  "bInfo": false,
  "bAutoWidth": false } );


  $('#defaulters_by_clinic').dataTable( {
  "sScrollY": "150px",
  "columnDefs": [{"targets":3,"type":"percent"}],  
  "bJQueryUI": true,
  "bPaginate": false,
  "bLengthChange": false,
  "bFilter": true,
  "bSort": true,
  "bInfo": false,
  "bAutoWidth": false } );



  $("#ltfu_date").datepicker({dateFormat: 'yy-mm-dd', changeMonth:true,changeYear:true} );
  $("#system_performance_start_date").datepicker({dateFormat: 'yy-mm-dd', changeMonth:true,changeYear:true} );
  $("#system_performance_end_date").datepicker({dateFormat: 'yy-mm-dd', changeMonth:true,changeYear:true} );

  $("#start_date_provider_indicators").datepicker({dateFormat: 'yy-mm-dd', changeMonth:true,changeYear:true} );
  $("#end_date_provider_indicators").datepicker({dateFormat: 'yy-mm-dd', changeMonth:true,changeYear:true} );


      


  });


</script>

<h3>Retention Control Panel</h3>
<ul>
  <li> <b>Identify patients who missed their last appointment</b>
    <form action='/ltfu/ltfu_by_range' method='post' id='defaulter_list_form'> {% csrf_token %}
    <table>
      <tr>
	<td>Clinic:</td>
	<td>
	  <select name='location_id'>
	    <option></option>
	    {% for location in locations %}
	    <option value='{{location.location_id}}'>{{location.name}}</option>
	    {% endfor %}
	  </select>
	  <br/>or<br/>
	  <select name='location_group_id'>
	    <option></option>
	    {% for g in location_groups %}
	    <option value='{{g.id}}'>{{g.name}}</option>
	    {%endfor%}
	  </select>
	</td>
	 <td>start range high risk:</td>
	 <td><input type='text' name='start_range_high_risk' value='8' size='1'/></td>
	<td>start range:</td>
	<td><input type='text' name='start_range' value='30' size='1'/></td>
	<td>end range:</td>
	<td><input type='text' name='end_range' value='89' size='1'/></td>
	<td>Limit to:</td>
	<td><input type='text' name='limit' size='1'/></td>
	<td><input type='button' onClick='download_defaulter_list()' value='Download List'/></td>
	<td><input type='button' onClick='view_defaulter_list()'  value='View'/></td>
      </tr>	  
    </table>
    </form>
  </li>
  <li><b>View Indicators Stratified By Clinic</b>
    <form action='/ltfu/view_indicators_by_clinic' method='post'> {% csrf_token %}
    <table>
      <tr>
	<td>Start Date:</td>
	<td><input type='text' name='start_date' id='system_performance_start_date'/></td>
	<td>End Date:</td>
	<td><input type='text' name='end_date' id='system_performance_end_date'/></td>
	<td><input type='submit'/></td>
      </tr>	  
    </table>
    </form>

  </li>

  <li><b>View Indicators Stratified By Provider</b>
    <form action='/ltfu/view_indicators_by_provider' method='post'> {% csrf_token %}
    <table>
      <tr>
	<td>Start Date:</td>
	<td><input type='text' name='start_date' id='start_date_provider_indicators'/></td>
	<td>End Date:</td>
	<td><input type='text' name='end_date' id='end_date_provider_indicators'/></td>
	<td><input type='submit'/></td>
      </tr>	  
    </table>
    </form>

  </li>

<!--
  <li><b>View Monthly Clinic Performance</b>
    <form action='/ltfu/view_clinic_indicators' method='post'> {% csrf_token %}
    <table>
      <tr>
	<td>Clinic:</td>
	<td>
	  <select name='location_id'>
	    {% for location in locations %}
	    <option value='{{location.location_id}}'>{{location.name}}</option>
	    {% endfor %}
	  </select>
	</td>
      </tr>	  
    </table>
    </form>

  </li>
  <li> <b>View Outreach Worker Performance</b>
    <form action='/ltfu/view_outreach_worker_performance' method='post'>
      <table>
	<tr>
	  <td>Outreach Worker</td>
	  <td>
	    <select name='provider_id'>
	      {% for provider in providers%}
	      <option value='{{provider.provider_id}}'>{{provider.family_name}}, {{provider.given_name}}</option>
	      {% endfor %}
	    </select>
	  </td>
	  <td>
	    <input type='submit'/>
	  </td>
	</tr>
      </table>
    </form>
  </li>
-->
  <li><a href='/ltfu/view_outreach_worker_forms_done'>View outreach worker forms done in past 7 days</a></li>
  <li><a href='/ltfu/view_data_entry_forms_done'>View data entry forms done in past 7 days</a></li>
    
</ul>

<hr>

<h3>Key System Indicators</h3>
<table id='system_indicators'>
  <thead>
    <tr>
      <td>year</td>
      <td>month</td>
      <td># of forms </td>
      <td>forms / day </td>
      <td># patients <br/>
	  followed up</td>
      <td># being traced</td>
      <td>% found</td>
      <td>% reached <br/>
	  by phone</td>
      <td># hiv+, not dead</td>
      <td>rtc rate, overall</td>
      <td>rtc rate, <br/>
          due to return</td>
    </tr>
  </thead>
  <tbody>
    {% for row in system_indicators %}    
    <tr>      
      <td>{{row.year}}</td>
      <td>{{row.month}}</td>
      <td>{{row|get:'# of forms'}}</td>
      <td>{{row|get:'forms / day'|floatformat:1}}</td>
      <td>{{row|get:'# patients followed-up'}}</td>
      <td>{{row|get:'# being traced'}}</td>
      <td>{{row|get:'perc found'|make_percent:1}}</td>
      <td>{{row|get:'perc reached by phone'|make_percent:1}}</td>
      <td>{{row|get:'# followed up, not dead, HIV+'}}</td>
      <td>{{row|get:'RTC rate, overall'|make_percent:1}}</td>
      <td>{{row|get:'RTC rate, due to return'|make_percent:1}}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<br/>
<hr>


<h3>Key System Indicators By Clinic</h3>
<table id='clinic_indicators'>
  <thead>
    <tr>
      <td>Clinic</td>
      <td>year</td>
      <td>month</td>
      <td># of forms </td>
      <td>forms / day </td>
      <td># patients <br/>
	  followed up</td>
      <td># being traced</td>
      <td>% found</td>
      <td>% reached <br/>
	  by phone</td>
      <td># hiv+, <br/>
          not dead</td>
      <td>rtc rate, overall</td>
      <td>rtc rate, <br/>
          due to return</td>
    </tr>
  </thead>
  <tbody>
    {% for row in clinic_indicators %}    
    <tr>
      <td>{{row.clinic}}</td>
      <td>{{row.year}}</td>
      <td>{{row.month}}</td>
      <td>{{row|get:'# of forms'}}</td>
      <td>{{row|get:'forms / day'|floatformat:1}}</td>
      <td>{{row|get:'# patients followed-up'}}</td>
      <td>{{row|get:'# being traced'}}</td>
      <td>{{row|get:'perc found'|make_percent:1}}</td>
      <td>{{row|get:'perc reached by phone'|make_percent:1}}</td>
      <td>{{row|get:'# followed up, not dead, HIV+'}}</td>
      <td>{{row|get:'RTC rate, overall'|make_percent:1}}</td>
      <td>{{row|get:'RTC rate, due to return'|make_percent:1}}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<br/>
<hr>




<h3>Current Defaulter Totals</h3>
<table id='defaulters_by_clinic'>
  <thead>
    <tr>
      <td>Clinic</td>      
      <td># defaulting</td>
      <td>% on list > 2 weeks</td>
    </tr>
  </thead>
  <tbody>
    {% for row in defaulters_by_clinic %}
    <tr>
      <td>{{row.clinic}}</td>
      <td>{{row|get:'requiring_follow_up'}}</td>
      <td>{{row|get:'on_list_gt_2_week' | percentage:row.requiring_follow_up}}</td>
    </tr>
    {%endfor%}    
  </tbody>
</table>
  
<hr>

{% endblock %}
